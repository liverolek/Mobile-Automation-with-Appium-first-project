"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("@appium/support");
var _teen_process = require("teen_process");
var _path = _interopRequireDefault(require("path"));
const STATUS_UNSET = 'unset';
const STATUS_NO = 'no';
const STATUS_YES = 'yes';
const WIX_SIM_UTILS = 'applesimutils';
const SERVICES = Object.freeze({
  calendar: 'kTCCServiceCalendar',
  camera: 'kTCCServiceCamera',
  contacts: 'kTCCServiceAddressBook',
  homekit: 'kTCCServiceWillow',
  microphone: 'kTCCServiceMicrophone',
  photos: 'kTCCServicePhotos',
  reminders: 'kTCCServiceReminders',
  medialibrary: 'kTCCServiceMediaLibrary',
  motion: 'kTCCServiceMotion',
  health: 'kTCCServiceMSO',
  siri: 'kTCCServiceSiri',
  speech: 'kTCCServiceSpeechRecognition'
});
function toInternalServiceName(serviceName) {
  if (_lodash.default.has(SERVICES, _lodash.default.toLower(serviceName))) {
    return SERVICES[_lodash.default.toLower(serviceName)];
  }
  throw new Error(`'${serviceName}' is unknown. Only the following service names are supported: ${JSON.stringify(_lodash.default.keys(SERVICES))}`);
}
function formatStatus(status) {
  return [STATUS_UNSET, STATUS_NO].includes(status) ? _lodash.default.toUpper(status) : status;
}
async function execSQLiteQuery(db, query) {
  _logger.default.debug(`Executing SQL query "${query}" on '${db}'`);
  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, query])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${query}" to '${db}'. Original error: ${err.stderr}`);
  }
}
async function execWix(args) {
  try {
    await _support.fs.which(WIX_SIM_UTILS);
  } catch (e) {
    throw new Error(`${WIX_SIM_UTILS} binary has not been found in your PATH. ` + `Please install it ('brew tap wix/brew && brew install wix/brew/applesimutils') to ` + `be able to change application permissions`);
  }
  _logger.default.debug(`Executing: ${WIX_SIM_UTILS} ${_support.util.quote(args)}`);
  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(WIX_SIM_UTILS, args);
    _logger.default.debug(`Command output: ${stdout}`);
    return stdout;
  } catch (e) {
    throw new Error(`Cannot execute "${WIX_SIM_UTILS} ${_support.util.quote(args)}". Original error: ${e.stderr || e.message}`);
  }
}
async function setAccess(udid, bundleId, permissionsMapping) {
  const permissionsArg = _lodash.default.toPairs(permissionsMapping).map(x => `${x[0]}=${formatStatus(x[1])}`).join(',');
  return await execWix(['--byId', udid, '--bundle', bundleId, '--setPermissions', permissionsArg]);
}
async function getAccess(bundleId, serviceName, simDataRoot) {
  const internalServiceName = toInternalServiceName(serviceName);
  const dbPath = _path.default.resolve(simDataRoot, 'Library', 'TCC', 'TCC.db');
  for (const [sqlValue, status] of [['0', STATUS_NO], ['1', STATUS_YES]]) {
    const sql = `SELECT count(*) FROM 'access' ` + `WHERE client='${bundleId}' AND allowed=${sqlValue} AND service='${internalServiceName}'`;
    const count = await execSQLiteQuery(dbPath, sql);
    if (parseInt(count.split('=')[1], 10) > 0) {
      return status;
    }
  }
  return STATUS_UNSET;
}
const extensions = {};
extensions.setPermission = async function setPermission(bundleId, permission, value) {
  await this.setPermissions(bundleId, {
    [permission]: value
  });
};
extensions.setPermissions = async function setPermissions(bundleId, permissionsMapping) {
  _logger.default.debug(`Setting access for '${bundleId}': ${JSON.stringify(permissionsMapping, null, 2)}`);
  await setAccess(this.udid, bundleId, permissionsMapping);
};
extensions.getPermission = async function getPermission(bundleId, serviceName) {
  const result = await getAccess(bundleId, serviceName, this.getDir());
  _logger.default.debug(`Got ${serviceName} access status for '${bundleId}': ${result}`);
  return result;
};
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTVEFUVVNfVU5TRVQiLCJTVEFUVVNfTk8iLCJTVEFUVVNfWUVTIiwiV0lYX1NJTV9VVElMUyIsIlNFUlZJQ0VTIiwiT2JqZWN0IiwiZnJlZXplIiwiY2FsZW5kYXIiLCJjYW1lcmEiLCJjb250YWN0cyIsImhvbWVraXQiLCJtaWNyb3Bob25lIiwicGhvdG9zIiwicmVtaW5kZXJzIiwibWVkaWFsaWJyYXJ5IiwibW90aW9uIiwiaGVhbHRoIiwic2lyaSIsInNwZWVjaCIsInRvSW50ZXJuYWxTZXJ2aWNlTmFtZSIsInNlcnZpY2VOYW1lIiwiXyIsImhhcyIsInRvTG93ZXIiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlzIiwiZm9ybWF0U3RhdHVzIiwic3RhdHVzIiwiaW5jbHVkZXMiLCJ0b1VwcGVyIiwiZXhlY1NRTGl0ZVF1ZXJ5IiwiZGIiLCJxdWVyeSIsImxvZyIsImRlYnVnIiwiZXhlYyIsInN0ZG91dCIsImVyciIsInN0ZGVyciIsImV4ZWNXaXgiLCJhcmdzIiwiZnMiLCJ3aGljaCIsImUiLCJ1dGlsIiwicXVvdGUiLCJtZXNzYWdlIiwic2V0QWNjZXNzIiwidWRpZCIsImJ1bmRsZUlkIiwicGVybWlzc2lvbnNNYXBwaW5nIiwicGVybWlzc2lvbnNBcmciLCJ0b1BhaXJzIiwibWFwIiwieCIsImpvaW4iLCJnZXRBY2Nlc3MiLCJzaW1EYXRhUm9vdCIsImludGVybmFsU2VydmljZU5hbWUiLCJkYlBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInNxbFZhbHVlIiwic3FsIiwiY291bnQiLCJwYXJzZUludCIsInNwbGl0IiwiZXh0ZW5zaW9ucyIsInNldFBlcm1pc3Npb24iLCJwZXJtaXNzaW9uIiwidmFsdWUiLCJzZXRQZXJtaXNzaW9ucyIsImdldFBlcm1pc3Npb24iLCJyZXN1bHQiLCJnZXREaXIiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXh0ZW5zaW9ucy9wZXJtaXNzaW9ucy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuY29uc3QgU1RBVFVTX1VOU0VUID0gJ3Vuc2V0JztcbmNvbnN0IFNUQVRVU19OTyA9ICdubyc7XG5jb25zdCBTVEFUVVNfWUVTID0gJ3llcyc7XG5jb25zdCBXSVhfU0lNX1VUSUxTID0gJ2FwcGxlc2ltdXRpbHMnO1xuY29uc3QgU0VSVklDRVMgPSBPYmplY3QuZnJlZXplKHtcbiAgY2FsZW5kYXI6ICdrVENDU2VydmljZUNhbGVuZGFyJyxcbiAgY2FtZXJhOiAna1RDQ1NlcnZpY2VDYW1lcmEnLFxuICBjb250YWN0czogJ2tUQ0NTZXJ2aWNlQWRkcmVzc0Jvb2snLFxuICBob21la2l0OiAna1RDQ1NlcnZpY2VXaWxsb3cnLFxuICBtaWNyb3Bob25lOiAna1RDQ1NlcnZpY2VNaWNyb3Bob25lJyxcbiAgcGhvdG9zOiAna1RDQ1NlcnZpY2VQaG90b3MnLFxuICByZW1pbmRlcnM6ICdrVENDU2VydmljZVJlbWluZGVycycsXG4gIG1lZGlhbGlicmFyeTogJ2tUQ0NTZXJ2aWNlTWVkaWFMaWJyYXJ5JyxcbiAgbW90aW9uOiAna1RDQ1NlcnZpY2VNb3Rpb24nLFxuICBoZWFsdGg6ICdrVENDU2VydmljZU1TTycsXG4gIHNpcmk6ICdrVENDU2VydmljZVNpcmknLFxuICBzcGVlY2g6ICdrVENDU2VydmljZVNwZWVjaFJlY29nbml0aW9uJyxcbn0pO1xuXG5mdW5jdGlvbiB0b0ludGVybmFsU2VydmljZU5hbWUgKHNlcnZpY2VOYW1lKSB7XG4gIGlmIChfLmhhcyhTRVJWSUNFUywgXy50b0xvd2VyKHNlcnZpY2VOYW1lKSkpIHtcbiAgICByZXR1cm4gU0VSVklDRVNbXy50b0xvd2VyKHNlcnZpY2VOYW1lKV07XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKFxuICAgIGAnJHtzZXJ2aWNlTmFtZX0nIGlzIHVua25vd24uIE9ubHkgdGhlIGZvbGxvd2luZyBzZXJ2aWNlIG5hbWVzIGFyZSBzdXBwb3J0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkoXy5rZXlzKFNFUlZJQ0VTKSl9YFxuICApO1xufVxuXG5mdW5jdGlvbiBmb3JtYXRTdGF0dXMgKHN0YXR1cykge1xuICByZXR1cm4gW1NUQVRVU19VTlNFVCwgU1RBVFVTX05PXS5pbmNsdWRlcyhzdGF0dXMpID8gXy50b1VwcGVyKHN0YXR1cykgOiBzdGF0dXM7XG59XG5cbi8qKlxuICogUnVucyBhIGNvbW1hbmQgbGluZSBzcWxpdGUzIHF1ZXJ5XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGRiIC0gRnVsbCBwYXRoIHRvIHNxbGl0ZSBkYXRhYmFzZVxuICogQHBhcmFtIHtzdHJpbmd9IHF1ZXJ5IC0gVGhlIGFjdHVhbCBxdWVyeSBzdHJpbmdcbiAqIEByZXR1cm5zIHtzdHJpbmd9IHNxbGl0ZSBjb21tYW5kIHN0ZG91dFxuICovXG5hc3luYyBmdW5jdGlvbiBleGVjU1FMaXRlUXVlcnkgKGRiLCBxdWVyeSkge1xuICBsb2cuZGVidWcoYEV4ZWN1dGluZyBTUUwgcXVlcnkgXCIke3F1ZXJ5fVwiIG9uICcke2RifSdgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGV4ZWMoJ3NxbGl0ZTMnLCBbJy1saW5lJywgZGIsIHF1ZXJ5XSkpLnN0ZG91dDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYENhbm5vdCBleGVjdXRlIFNRTGl0ZSBxdWVyeSBcIiR7cXVlcnl9XCIgdG8gJyR7ZGJ9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLnN0ZGVycn1gXG4gICAgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjV2l4IChhcmdzKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goV0lYX1NJTV9VVElMUyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgJHtXSVhfU0lNX1VUSUxTfSBiaW5hcnkgaGFzIG5vdCBiZWVuIGZvdW5kIGluIHlvdXIgUEFUSC4gYCArXG4gICAgICBgUGxlYXNlIGluc3RhbGwgaXQgKCdicmV3IHRhcCB3aXgvYnJldyAmJiBicmV3IGluc3RhbGwgd2l4L2JyZXcvYXBwbGVzaW11dGlscycpIHRvIGAgK1xuICAgICAgYGJlIGFibGUgdG8gY2hhbmdlIGFwcGxpY2F0aW9uIHBlcm1pc3Npb25zYFxuICAgICk7XG4gIH1cblxuICBsb2cuZGVidWcoYEV4ZWN1dGluZzogJHtXSVhfU0lNX1VUSUxTfSAke3V0aWwucXVvdGUoYXJncyl9YCk7XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKFdJWF9TSU1fVVRJTFMsIGFyZ3MpO1xuICAgIGxvZy5kZWJ1ZyhgQ29tbWFuZCBvdXRwdXQ6ICR7c3Rkb3V0fWApO1xuICAgIHJldHVybiBzdGRvdXQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBleGVjdXRlIFwiJHtXSVhfU0lNX1VUSUxTfSAke3V0aWwucXVvdGUoYXJncyl9XCIuIE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIFNldHMgcGVybWlzc2lvbnMgZm9yIHRoZSBnaXZlbiBhcHBsaWNhdGlvblxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIC0gdWRpZCBvZiB0aGUgdGFyZ2V0IHNpbXVsYXRvciBkZXZpY2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBidW5kbGUgaWRlbnRpZmllciBvZiB0aGUgdGFyZ2V0IGFwcGxpY2F0aW9uLlxuICogQHBhcmFtIHtPYmplY3R9IHBlcm1pc3Npb25zTWFwcGluZyAtIEFuIG9iamVjdCwgd2hlcmUga2V5cyBhciAgc2VydmljZSBuYW1lc1xuICogYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyBzdGF0ZSB2YWx1ZXMuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vd2l4L0FwcGxlU2ltdWxhdG9yVXRpbHNcbiAqIGZvciBtb3JlIGRldGFpbHMgb24gYXZhaWxhYmxlIHNlcnZpY2UgbmFtZXMgYW5kIHN0YXR1c2VzLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBjaGFuZ2luZyBwZXJtaXNzaW9ucy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0QWNjZXNzICh1ZGlkLCBidW5kbGVJZCwgcGVybWlzc2lvbnNNYXBwaW5nKSB7XG4gIGNvbnN0IHBlcm1pc3Npb25zQXJnID0gXy50b1BhaXJzKHBlcm1pc3Npb25zTWFwcGluZylcbiAgICAubWFwKCh4KSA9PiBgJHt4WzBdfT0ke2Zvcm1hdFN0YXR1cyh4WzFdKX1gKVxuICAgIC5qb2luKCcsJyk7XG4gIHJldHVybiBhd2FpdCBleGVjV2l4KFtcbiAgICAnLS1ieUlkJywgdWRpZCxcbiAgICAnLS1idW5kbGUnLCBidW5kbGVJZCxcbiAgICAnLS1zZXRQZXJtaXNzaW9ucycsIHBlcm1pc3Npb25zQXJnLFxuICBdKTtcbn1cblxuLyoqXG4gKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgcGVybWlzc2lvbiBzdGF0dXMgZm9yIHRoZSBnaXZlbiBzZXJ2aWNlIGFuZCBhcHBsaWNhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBidW5kbGUgaWRlbnRpZmllciBvZiB0aGUgdGFyZ2V0IGFwcGxpY2F0aW9uLlxuICogQHBhcmFtIHtzdHJpbmd9IHNlcnZpY2VOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UuIFNob3VsZCBiZSBvbmUgb2ZcbiAqIGBTRVJWSUNFU2Aga2V5cy5cbiAqIEBwYXJhbSB7c3RyaW5nfSBzaW1EYXRhUm9vdCAtIHRoZSBwYXRoIHRvIFNpbXVsYXRvciBgZGF0YWAgcm9vdFxuICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgY3VycmVudCBzdGF0dXM6IHllcy9uby91bnNldFxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSByZXRyaWV2aW5nIHBlcm1pc3Npb25zLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRBY2Nlc3MgKGJ1bmRsZUlkLCBzZXJ2aWNlTmFtZSwgc2ltRGF0YVJvb3QpIHtcbiAgY29uc3QgaW50ZXJuYWxTZXJ2aWNlTmFtZSA9IHRvSW50ZXJuYWxTZXJ2aWNlTmFtZShzZXJ2aWNlTmFtZSk7XG4gIGNvbnN0IGRiUGF0aCA9IHBhdGgucmVzb2x2ZShzaW1EYXRhUm9vdCwgJ0xpYnJhcnknLCAnVENDJywgJ1RDQy5kYicpO1xuICBmb3IgKGNvbnN0IFtzcWxWYWx1ZSwgc3RhdHVzXSBvZiBbWycwJywgU1RBVFVTX05PXSwgWycxJywgU1RBVFVTX1lFU11dKSB7XG4gICAgY29uc3Qgc3FsID0gYFNFTEVDVCBjb3VudCgqKSBGUk9NICdhY2Nlc3MnIGAgK1xuICAgICAgYFdIRVJFIGNsaWVudD0nJHtidW5kbGVJZH0nIEFORCBhbGxvd2VkPSR7c3FsVmFsdWV9IEFORCBzZXJ2aWNlPScke2ludGVybmFsU2VydmljZU5hbWV9J2A7XG4gICAgY29uc3QgY291bnQgPSBhd2FpdCBleGVjU1FMaXRlUXVlcnkoZGJQYXRoLCBzcWwpO1xuICAgIGlmIChwYXJzZUludChjb3VudC5zcGxpdCgnPScpWzFdLCAxMCkgPiAwKSB7XG4gICAgICByZXR1cm4gc3RhdHVzO1xuICAgIH1cbiAgfVxuICByZXR1cm4gU1RBVFVTX1VOU0VUO1xufVxuXG5cbmNvbnN0IGV4dGVuc2lvbnMgPSB7fTtcblxuLyoqXG4gKiBTZXRzIHRoZSBwYXJ0aWN1bGFyIHBlcm1pc3Npb24gdG8gdGhlIGFwcGxpY2F0aW9uIGJ1bmRsZS4gU2VlXG4gKiBodHRwczovL2dpdGh1Yi5jb20vd2l4L0FwcGxlU2ltdWxhdG9yVXRpbHMgZm9yIG1vcmUgZGV0YWlscyBvblxuICogdGhlIGF2YWlsYWJsZSBzZXJ2aWNlIG5hbWVzIGFuZCBzdGF0dXNlcy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBBcHBsaWNhdGlvbiBidW5kbGUgaWRlbnRpZmllci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwZXJtaXNzaW9uIC0gU2VydmljZSBuYW1lIHRvIGJlIHNldC5cbiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBkZXNpcmVkIHN0YXR1cyBmb3IgdGhlIHNlcnZpY2UuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGNoYW5naW5nIHBlcm1pc3Npb24uXG4gKi9cbmV4dGVuc2lvbnMuc2V0UGVybWlzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIHNldFBlcm1pc3Npb24gKGJ1bmRsZUlkLCBwZXJtaXNzaW9uLCB2YWx1ZSkge1xuICBhd2FpdCB0aGlzLnNldFBlcm1pc3Npb25zKGJ1bmRsZUlkLCB7W3Blcm1pc3Npb25dOiB2YWx1ZX0pO1xufTtcblxuLyoqXG4gKiBTZXRzIHRoZSBwZXJtaXNzaW9ucyBmb3IgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gYnVuZGxlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIEFwcGxpY2F0aW9uIGJ1bmRsZSBpZGVudGlmaWVyLlxuICogQHBhcmFtIHtPYmplY3R9IHBlcm1pc3Npb25zTWFwcGluZyAtIEEgbWFwcGluZyB3aGVyZSBrYXlzXG4gKiBhcmUgc2VydmljZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSB0aGVpciBjb3JyZXNwb25kaW5nIHN0YXR1cyB2YWx1ZXMuXG4gKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3dpeC9BcHBsZVNpbXVsYXRvclV0aWxzXG4gKiBmb3IgbW9yZSBkZXRhaWxzIG9uIGF2YWlsYWJsZSBzZXJ2aWNlIG5hbWVzIGFuZCBzdGF0dXNlcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgY2hhbmdpbmcgcGVybWlzc2lvbnMuXG4gKi9cbmV4dGVuc2lvbnMuc2V0UGVybWlzc2lvbnMgPSBhc3luYyBmdW5jdGlvbiBzZXRQZXJtaXNzaW9ucyAoYnVuZGxlSWQsIHBlcm1pc3Npb25zTWFwcGluZykge1xuICBsb2cuZGVidWcoYFNldHRpbmcgYWNjZXNzIGZvciAnJHtidW5kbGVJZH0nOiAke0pTT04uc3RyaW5naWZ5KHBlcm1pc3Npb25zTWFwcGluZywgbnVsbCwgMil9YCk7XG4gIGF3YWl0IHNldEFjY2Vzcyh0aGlzLnVkaWQsIGJ1bmRsZUlkLCBwZXJtaXNzaW9uc01hcHBpbmcpO1xufTtcblxuLyoqXG4gKiBSZXRyaWV2ZXMgY3VycmVudCBwZXJtaXNzaW9uIHN0YXR1cyBmb3IgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGJ1bmRsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgLSBBcHBsaWNhdGlvbiBidW5kbGUgaWRlbnRpZmllci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlTmFtZSAtIE9uZSBvZiBhdmFpbGFibGUgc2VydmljZSBuYW1lcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgcmV0cmlldmluZyBwZXJtaXNzaW9ucy5cbiAqL1xuZXh0ZW5zaW9ucy5nZXRQZXJtaXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0UGVybWlzc2lvbiAoYnVuZGxlSWQsIHNlcnZpY2VOYW1lKSB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEFjY2VzcyhidW5kbGVJZCwgc2VydmljZU5hbWUsIHRoaXMuZ2V0RGlyKCkpO1xuICBsb2cuZGVidWcoYEdvdCAke3NlcnZpY2VOYW1lfSBhY2Nlc3Mgc3RhdHVzIGZvciAnJHtidW5kbGVJZH0nOiAke3Jlc3VsdH1gKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLE1BQU1BLFlBQVksR0FBRyxPQUFPO0FBQzVCLE1BQU1DLFNBQVMsR0FBRyxJ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